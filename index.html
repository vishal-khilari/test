<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ActiveGridX - Discovery</title>

    <!-- MapTiler / MapLibre dependencies -->
    <link
      href="https://cdn.maptiler.com/maplibre-gl-js/v3.5.0/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdn.maptiler.com/maplibre-gl-js/v3.5.0/maplibre-gl.js"></script>

    <link
      href="https://cdn.maptiler.com/leaflet-maptiler-geocoding/v2.0.0/leaflet-maptiler-geocoding.css"
      rel="stylesheet"
    />
    <script src="https://cdn.maptiler.com/leaflet-maptiler-geocoding/v2.0.0/leaflet-maptiler-geocoding.js"></script>

    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
      }
      #map {
        width: 100%;
        height: 100vh;
      }

      /* Floating info box */
      .info-box {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 12px 16px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
        z-index: 10;
        font-size: 14px;
      }

      @media (max-width: 768px) {
        .info-box {
          width: 90%;
          font-size: 13px;
        }
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div class="info-box" id="infoBox">Detecting your location...</div>

    <script>
      const apiKey = "HWm8o58Zk7yx5sWSFk8Y";
      const webhook =
        "https://n8n-s73k.onrender.com/webhook-test/627cc33d-de66-4ea7-aed2-6fc5e2a27a08";

      // Initialize map
      const map = new maplibregl.Map({
        container: "map",
        style: `https://api.maptiler.com/maps/streets/style.json?key=${apiKey}`,
        center: [77.5946, 12.9716],
        zoom: 12,
      });

      map.addControl(new maplibregl.NavigationControl(), "top-right");

      // Add search control (MapTiler geocoding)
      const geocoder = new maptiler.Geocoder({
        apiKey: apiKey,
        placeholder: "Search for turf or ground...",
      });
      map.addControl(geocoder, "top-left");

      // Function to send location to n8n
      async function sendToWebhook(lat, lng, name = "User Location") {
        try {
          await fetch(webhook, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              event: "user_location",
              name,
              latitude: lat,
              longitude: lng,
              time: new Date().toISOString(),
            }),
          });
          console.log("ðŸ“¤ Location sent:", lat, lng);
        } catch (e) {
          console.error("Webhook error:", e);
        }
      }

      // Add user marker
      let userMarker;

      // Detect user location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            map.setCenter([lng, lat]);
            userMarker = new maplibregl.Marker({
              color: "#00bcd4",
              draggable: true,
            })
              .setLngLat([lng, lat])
              .setPopup(new maplibregl.Popup().setText("Your location"))
              .addTo(map)
              .togglePopup();

            sendToWebhook(lat, lng, "Initial Location");
            document.getElementById("infoBox").innerText =
              "Drag the pin to adjust your location.";

            userMarker.on("dragend", () => {
              const { lat, lng } = userMarker.getLngLat();
              sendToWebhook(lat, lng, "Updated Location");
            });
          },
          () => {
            document.getElementById("infoBox").innerText =
              "Could not detect location. Please search manually.";
          }
        );
      }

      // Example ground markers
      const grounds = [
        { name: "ArenaX Turf", coords: [72.8777, 19.076] },
        { name: "FitZone Ground", coords: [73.8567, 18.5204] },
        { name: "ActivePlay Arena", coords: [77.5946, 12.9716] },
      ];

      // Add markers for grounds
      grounds.forEach((g) => {
        const marker = new maplibregl.Marker({ color: "#2ecc71" })
          .setLngLat(g.coords)
          .setPopup(new maplibregl.Popup().setHTML(`<b>${g.name}</b>`))
          .addTo(map);
      });

      // When user selects a place from search
      geocoder.on("select", async (result) => {
        const [lng, lat] = result.center;
        sendToWebhook(lat, lng, result.place_name);
      });
    </script>
  </body>
</html>
